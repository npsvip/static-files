/*
*上传图片并本地预览插件
*兼容IE8
*obj    ----上传图片容器
*picNum ----上传图片的张数
*width  ----图片宽度
*height ----图片宽度
 */
(function(b){function c(a,d){this.obj=a;this.$obj=b(a);0==d.picStyle&&(this.defaultOpt={picStyle:0,picNum:1,width:200,height:200},this.options=b.extend({},this.defaultOpt,d));1==d.picStyle&&(this.defaultOpt={picStyle:1,picNum:1,width:200,height:200,realWidth:200,realHeight:200},this.options=b.extend({},this.defaultOpt,d));c[this.options.classname+"successfun"]=this.options.success;this.init()}c.prototype.init=function(){this.$obj.append(b('\x3cinput type\x3d"file" name\x3d"multipartFile" class\x3d"'+this.options.classname+'" id\x3d"file" \x3e\x3cdiv class\x3d"'+this.options.prevclass+'" id\x3d"previewBox" style\x3d"position: absolute; display: inline-block; z-index:1;max-width: '+this.options.maxwidth+"; max-height: "+this.options.maxheight+';" \x3e\x3cimg id\x3d"uploadImg" src\x3d"images/uploadImg.png"  width\x3d'+this.options.width+" height\x3d"+this.options.height+"\x3e"));this.bindEvent(this.options.classname)};c.prototype.bindEvent=function(a){var d=this;this.$obj.on("click.choose","."+this.options.prevclass,function(){b("."+a).trigger("click")});b("."+a).on("change.upload",function(){d.operationImg(this)});this.$obj.off(".choose,.upload")};c.prototype.testWidthHeight=function(a,b){debugger;if(0==this.options.picStyle){if(a===this.options.width&&b===this.options.height)return alert("\u9009\u62e9\u7684\u56fe\u7247\u521a\u521a\u597d"),!0;alert("\u60a8\u9009\u62e9\u7684\u56fe\u7247\u5bbd\u9ad8\u4e0d\u7b26\u5408\u8981\u6c42\uff0c\u8bf7\u9009\u62e9\u5bbd"+this.options.width+"px*\u9ad8"+this.options.height+"px\u7684\u56fe\u7247");return!1}if(1==this.options.picStyle){debugger;var c=b/this.options.height,d=a/this.options.width;c>d?(this.options.realWidth=a/c,this.options.realHeight=this.options.height):(this.options.realHeight=b/d,this.options.realWidth=this.options.width);return!0}};c.prototype.testWidthHeightIE=function(a){a=new Image;a.src=document.getElementById("file").value;width=a.width;height=a.height};c.prototype.isImg=function(a){if(/.+\.(jpg|JPG|png|PNG|jpeg|JPEG|gif|GIF)$/.test(a))return!0;b.showAlert({title:"\u64cd\u4f5c\u5931\u8d25",body:"\u60a8\u9009\u62e9\u7684\u56fe\u7247\u683c\u5f0f\u6709\u8bef\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9"});return!1};c.prototype.addImgHtml=function(a){b("."+this.options.prevclass)&&b("."+this.options.prevclass).html("\x3cimg src\x3d"+a+" width\x3d"+this.options.realWidth+" height\x3d"+this.options.realHeight+"\x3e")};c.prototype.previewImgIE=function(a){a.select();b(a).blur();if(document.selection&&(a=document.selection.createRange().text,this.isImg(a))){if(1==this.options.picNum)b("."+this.options.prevclass).html(b("\x3cdiv class\x3d'imgWrap' id\x3d'img'\x3e\x3c/div\x3e"));else if(1<this.options.picNum&&this.num<this.options.picNum)b("."+this.options.prevclass).append(b("\x3cdiv class\x3d'imgWrap' id\x3d'img'\x3e\x3c/div\x3e")),this.num++;else return;b(".imgWrap").css({width:this.options.width,height:this.options.height,display:"inline-block","margin-right":"10px","*display":"inline","*zoom":1});b(".imgWrap:last").css("filter",'progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod \x3d scale,src\x3d"'+a+'")');this.testWidthHeightIE(document.getElementById("file"))}};c.prototype.previewImg=function(a){debugger;a=a.files[0];var c=this;if(this.isImg(a.name)){var e=new FileReader;e.onload=function(a){var d=a.target.result,e=new Image;e.onload=function(){c.testWidthHeight(e.width,e.height)&&(c.addImgHtml(a.target.result),b("#uploadImg").css("display","block"))};e.src=d};e.readAsDataURL(a)}else return alert("\u60a8\u8f93\u5165\u7684\u56fe\u7247\u683c\u5f0f\u6709\u8bef\uff0c\u8bf7\u91cd\u65b0\u8f93\u5165"),!1};c.prototype.operationImg=function(a){if(a.files&&a.files[0]){var d=new FormData;d.append("file",a.files[0]);if(1<a.files[0].size/1048576)b.showAlert({title:"\u64cd\u4f5c\u5931\u8d25",body:"\u7167\u7247\u5927\u5c0f\u4e0d\u8981\u8d85\u8fc71M"});else{var e=this;b.ajax({url:"/nps/upload",type:"POST",data:d,processData:!1,contentType:!1,dataType:"JSON",headers:{token:localStorage.getItem("token")},success:function(d){"success"==d.msg?(c[e.options.classname+"successfun"](d),e.previewImg(a)):b.showAlert({title:"\u64cd\u4f5c\u5931\u8d25",body:d.msg})}})}}};b.fn.uploadImg=function(a){return this.each(function(){new c(this,a)})}})(jQuery);